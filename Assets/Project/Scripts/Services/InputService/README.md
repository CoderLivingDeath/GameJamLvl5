# Сервис ввода (InputService) для GameJamLvl5

Данный класс `InputService` представляет собой централизованный менеджер ввода, который отвечает за управление действиями ввода (Input Actions) и их подписчиками. Он позволяет легко включать, отключать и корректно освобождать ресурсы, связанные с системой ввода.

---

## Описание

`InputService` инкапсулирует:

- управление сгенерированными действиями ввода (`InputSystem_Actions`);
- контейнер подписчиков на события ввода (`InputSubscribersContainer`).

Класс обеспечивает удобные методы для активации и деактивации всей системы ввода, а также корректное освобождение всех ресурсов при уничтожении.

---

## Конструкция

```csharp
public InputService(InputSystem_Actions inputActions, InputSubscribersContainer subscribers)
```

- **inputActions** — сгенерированные действия Unity Input System, должны быть не null;
- **subscribers** — контейнер подписчиков для обработки обратных вызовов ввода, также обязателен.

При создании `InputService` автоматически производится включение ввода и активных подписок.

---

## Основные методы

### Enable()

Включает действиеми ввода и подписчиков. Вызывать, когда необходимо начать принимать ввод.

### Disable()

Выключает действия ввода и подписчиков, останавливая обработку ввода.

### Dispose()

Корректно освобождает все ресурсы сервиса ввода, отключает подписчиков и действия ввода. После вызова объект считается уничтоженным и использовать его нельзя.

---

## Исключения

- Если попытаться вызвать `Enable()` или `Disable()` после удаления (вызывается `Dispose()`), сервис выбросит исключение `ObjectDisposedException`.

---

# Класс InputSubscriber

Класс `InputSubscriber` предназначен для управления подпиской на события Unity Input System (`InputAction`). Он инкапсулирует логику подписки и отписки для различных фаз события ввода и обеспечивает корректное управление жизненным циклом подписчиков.

---

## Описание

- **Представляет подписчика** на конкретное событие `InputAction` с заданным обратным вызовом и типом вызова (`OnStarted`, `OnPerformed`, `OnCanceled`).
- Позволяет **включать и отключать** подписку.
- Поддерживает **корректное освобождение ресурсов** через реализацию интерфейса `IDisposable`.
- Проверяет состояние объекта, чтобы избежать ошибок после удаления (dispose).

---

## Основные возможности

### CallType

Перечисление, определяющее фазу события, на которое подписывается клиент:

- `OnStarted` — событие начала ввода.
- `OnPerformed` — событие выполнения ввода.
- `OnCanceled` — событие отмены ввода.

### Конструктор

```csharp
InputSubscriber(InputAction action, Action callback, CallType type)
```

- Принимает действие ввода (`InputAction`), обратный вызов (`callback`) и тип вызова (`type`).
- Выбрасывает `ArgumentNullException`, если `action` или `callback` равны `null`.

### Основные методы

- `Enable()` — подписывает обратный вызов на событие ввода, соответствующее типу вызова.
- `Disable()` — отписывает обратный вызов.
- `Dispose()` — отключает подписку и помечает объект как освобожденный.
- `ThrowIfDisposed()` — проверка, выбрасывающая исключение, если объект уже освобожден.

### Свойства

- `IsActive` — возвращает, активна ли подписка в данный момент.
- `IsDisposed` — возвращает, был ли объект освобожден.

---
# InputSubscribersContainer

`InputSubscribersContainer` — это контейнер для управления подписчиками на события Unity Input System (`InputAction`). Он обеспечивает удобные методы для подписки, отписки, активации и деактивации обработчиков ввода, а также корректного освобождения ресурсов.

---

## Описание

- Позволяет управлять группой подписчиков (`InputSubscriber`), каждый из которых связан с определённым ключом и типом вызова (фазой `InputAction` — `Started`, `Performed`, `Canceled`).
- Обеспечивает централизованное включение и выключение всех подписчиков.
- Автоматически следит за корректностью ключей с помощью механизма `BuildKeyPath`.
- Обеспечивает безопасное удаление и освобождение памяти при отписке или при вызове `Dispose()`.

---

## Основные возможности

### Подписка

- Метод `Subscribe` позволяет зарегистрировать событие с заданным ключом, `InputAction`, колбэком и типом вызова.
- Есть удобные методы-обёртки для фаз input-событий:
  - `SubscribeStarted`
  - `SubscribePerformed`
  - `SubscribeCanceled`
- Можно также подписать готовый объект `InputSubscriber` с помощью `Subscribe(string key, InputSubscriber subscriber)`.

### Отписка

- Метод `Unsubscribe(string key)` удаляет подписчика по ключу.
- Метод `Unsubscribe(string key, InputSubscriber.CallType callType)` позволяет отписать подписчика по ключу с указанием конкретного типа вызова.
- Удобные методы для каждого типа вызова:
  - `UnsubscribeStarted`
  - `UnsubscribePerformed`
  - `UnsubscribeCanceled`

### Управление состоянием

- `Enable()` — включает все подписчики (подписывает колбэки на `InputAction`).
- `Disable()` — выключает все подписчики, отписывая колбэки.
- Следит за своим состоянием, предотвращая повторную активацию или деактивацию.

### Жизненный цикл и очистка

- Метод `Dispose()` освобождает ресурсы всех подписчиков и очищает контейнер.
- Внутренние проверки (`ThrowIfDisposed()`) предотвращают доступ после удаления.

---

## Формат ключей

- Ключи входят в формат с сегментами, разделёнными `/`, например: `"gameplay/move"`, `"ui/click"`.
- `BuildKeyPath` формирует композитный ключ с добавлением типа вызова (например, `"gameplay/move/performed"`).
- Формат ключа проверяется, и в случае ошибки вызывается исключение `InputKeyFormatKeyException`.

---
# InputKeyFormatter

`InputKeyFormatter` — это утилитный статический класс, предназначенный для форматирования и проверки строковых ключей ввода в формате сегментов, разделённых символом `/`.

---

## Назначение

- Проверять корректность формата ключа (строка должна иметь структуру `"segment/segment/..."`).
- Приводить ключи к единообразному виду: без пробелов, в нижнем регистре.
- Обеспечивать безопасное преобразование строк в нужный формат с проверкой.

---

## Описание методов

### `IsValid(string input) : bool`

Проверяет, соответствует ли переданная строка шаблону вида `"segment/segment/..."`.

- Возвращает `true`, если строка не пустая и полностью соответствует шаблону.
- Возвращает `false` в противном случае.

---

### `Format(string input) : string`

Форматирует входную строку:

- Убирает пробелы вокруг сегментов.
- Приводит все символы к нижнему регистру.
- Проверяет корректность формата.
- Возвращает корректно отформатированную строку или `null`, если формат ошибки.

---

### `TryFormatKey(string input, out string result) : bool`

Пытливое преобразование строки в корректный ключ.

- Если форматирование прошло успешно, возвращает `true` и выводит результат через `result`.
- Если формат некорректен, возвращает `false` и `result` будет `null`.

---
# InputKeyBuilder

`InputKeyBuilder` — это удобный класс-конструктор для создания составных ключей ввода. Он позволяет поэтапно собирать ключ из сегментов и задавать тип вызова (phase) для последующего использования в системе ввода.

---

## Назначение

- Создавать ключи в виде строкового пути из сегментов, разделённых символом `'/'`.
- Добавлять к ключу тип вызова (`started`, `performed`, `canceled`), соответствующий фазам событий Unity Input System.
- Обеспечивать валидацию ключей и их корректное форматирование.
- Позволять многоразовое использование через метод очистки.

---

## Основные возможности

### Добавление сегментов

Метод `Append(string segment)`:

- Позволяет добавлять отдельные сегменты (части пути), например `"gameplay"`, `"move"` и т.п.
- Автоматически очищает входные данные от пробелов и приводит их к нижнему регистру.
- Бросает исключение, если сегмент пустой либо состоит из пробелов.

### Установка типа вызова

Метод `SetCallType(InputSubscriber.CallType type)`:

- Позволяет указать одну из фаз ввода:
  - `OnStarted`
  - `OnPerformed`
  - `OnCanceled`

### Формирование итогового ключа

Переопределённый метод `ToString()`:

- Формирует строку ключа в формате:

  ```
  сегмент1/сегмент2/.../calltype
  ```

  Например: `"gameplay/move/performed"`

- Проверяет корректность формата ключа.
- Бросает исключения, если ключ не содержит сегментов или тип вызова не установлен.

### Очистка состояния

Метод `Clear()`:

- Сбрасывает накопленные сегменты и тип вызова.
- Позволяет переиспользовать экземпляр билдера.

---

## Пример использования

```csharp
var builder = new InputKeyBuilder();
string key = builder
    .Append("Gameplay")
    .Append("Move")
    .SetCallType(InputSubscriber.CallType.OnPerformed)
    .ToString();

// key == "gameplay/move/performed"
```

---

## Зачем использовать?

- Обеспечивает удобный и безопасный способ построения ключей в системе ввода.
- Помогает избежать ошибок в форматировании путей и типов вызова.
- Упрощает поддержку и расширение механизма подписок на ввод.
- Делает код более читабельным и структурированным.

---
